name: EAS Update

on:
  push:
    branches:
      - main
      - develop
    paths-ignore:
      - "**.md"
      - ".github/**"
      - "assets/**"
      - "docs/**"
  pull_request:
    branches:
      - main
      - develop
    paths-ignore:
      - "**.md"
      - ".github/**"
      - "assets/**"
      - "docs/**"

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

jobs:
  update:
    name: Publish EAS Update
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Check for EXPO_TOKEN
        run: |
          if [ -z "$EXPO_TOKEN" ]; then
            echo "You must provide an EXPO_TOKEN secret linked to this project's Expo account in this repo's secrets. Learn more: https://docs.expo.dev/eas-update/github-actions"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "yarn"

      - name: Setup Expo CLI
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ env.EXPO_TOKEN }}

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Publish update to production
        run: |
          eas update --auto --branch production --message "Update from GitHub Actions - ${{ github.sha }}"
        env:
          EXPO_TOKEN: ${{ env.EXPO_TOKEN }}

  update-preview:
    name: Publish EAS Update (Preview)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'

    steps:
      - name: Check for EXPO_TOKEN
        run: |
          if [ -z "$EXPO_TOKEN" ]; then
            echo "You must provide an EXPO_TOKEN secret linked to this project's Expo account in this repo's secrets. Learn more: https://docs.expo.dev/eas-update/github-actions"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "yarn"

      - name: Setup Expo CLI
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ env.EXPO_TOKEN }}

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Publish update to preview
        run: |
          eas update --auto --branch preview --message "Preview update from GitHub Actions - ${{ github.sha }}"
        env:
          EXPO_TOKEN: ${{ env.EXPO_TOKEN }}

  update-development:
    name: Publish EAS Update (Development)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref != 'refs/heads/main' && github.ref != 'refs/heads/develop'

    steps:
      - name: Check for EXPO_TOKEN
        run: |
          if [ -z "$EXPO_TOKEN" ]; then
            echo "You must provide an EXPO_TOKEN secret linked to this project's Expo account in this repo's secrets. Learn more: https://docs.expo.dev/eas-update/github-actions"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "yarn"

      - name: Setup Expo CLI
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ env.EXPO_TOKEN }}

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Publish update to development
        run: |
          eas update --auto --branch development --message "Development update from GitHub Actions - ${{ github.sha }}"
        env:
          EXPO_TOKEN: ${{ env.EXPO_TOKEN }}
